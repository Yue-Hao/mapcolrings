;;Yue Hao
;;CS 580 Fall 2014
;;Dr. Duric
;;Project

(load "cutset.lisp")
(load "treecoloring.lisp")

(defun update-domains (states color_pair domains)
  (mapcar (lambda (x)
	    (list (first x)
		  (cond ((eq (first color_pair) (first x))
			 (list (second color_pair)))
			((member (first color_pair) (second (assoc (first x) states)))
			  (remove (second color_pair) (second x)))
			(t (second x)))))
	  domains))

(defun gen-colorings-aux (domains c_states states colors t_sorted)
  "generate all possible color assignments for c_states using forward checking.
  domains: color domains of c_states ((A (R G)) (B (G))...);
  c_states: assoc list of the cutset;
  states: assoc list of the map;
  colors: list of colors to be assigned;
  c_states_cp: a backup copy of the original states;
  t_sorted: topologically sorted remaining trees"
  (let ((s (first c_states)))
    (if (null c_states)
	;;basic condition: no more countries in 'c_states' to be assigned
	(let ((c_coloring (mapcar (lambda (x)
				    (list (first x) (first (second x))))
				  domains)))
	  (gen-tree-colorings t_sorted c_coloring states colors))
	(dolist (x (second (assoc (first s) domains)))
	  (let ((new_domains (update-domains
			      states
			      (list (first s) x)
			      domains)))
	    (if (not (some #'null (mapcar #'second new_domains)))
		(gen-colorings-aux
		 new_domains
		 (rest c_states)
		 states
		 colors
		 t_sorted)))))))

(defun gen-colorings (states colors)
  "initial call of 'gen-color-assign'"
  (let ((c_vertices (greedy-algorithm states)))
    (let ((c_states (build-subgraph-V-in-G states c_vertices))
	  (t_states (remove-V-from-G states c_vertices)))
      (gen-colorings-aux
       (mapcar (lambda (x) (list (first x) colors)) c_states)
       (stable-sort c_states #'> :key #'(lambda (x) (list-length (second x))))
       states
       colors
       (topological-sort t_states)))))
